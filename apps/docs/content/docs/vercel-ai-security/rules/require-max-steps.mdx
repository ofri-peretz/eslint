---
title: "require-max-steps"
description: Prevents infinite tool calling loops in multi-step agents.
category: security
severity: medium
tags: ['security', 'ai', 'llm']
autofix: false
---

> Prevents infinite tool calling loops in multi-step agents.

## üìä Rule Details

| Property           | Value                                                                                                       |
| ------------------ | ----------------------------------------------------------------------------------------------------------- |
| **Type**           | suggestion                                                                                                  |
| **Severity**       | üü° HIGH                                                                                                     |
| **OWASP LLM**      | [LLM10: Unbounded Consumption](https://owasp.org/www-project-top-10-for-large-language-model-applications/) |
| **CWE**            | [CWE-834: Excessive Iteration](https://cwe.mitre.org/data/definitions/834.html)                             |
| **CVSS**           | 6.5                                                                                                         |
| **Config Default** | `warn` (recommended), `error` (strict)                                                                      |

## üîç What This Rule Detects

This rule identifies AI SDK calls that use tools but don't specify a `maxSteps` limit. Without limits, AI agents can enter infinite loops calling tools repeatedly.

## ‚ùå Incorrect Code

```typescript
// Tools without maxSteps
await generateText({
  model: openai('gpt-4'),
  prompt: 'Research and summarize',
  tools: {
    search: searchTool,
    summarize: summarizeTool,
  },
});

// Multi-tool agent without limit
await streamText({
  model: anthropic('claude-3'),
  prompt: 'Complete the task',
  tools: { search, write, deploy },
});
```

## ‚úÖ Correct Code

```typescript
// With maxSteps limit
await generateText({
  model: openai('gpt-4'),
  prompt: 'Research and summarize',
  tools: {
    search: searchTool,
    summarize: summarizeTool,
  },
  maxSteps: 5,
});

// Bounded agent
await streamText({
  model: anthropic('claude-3'),
  prompt: 'Complete the task',
  tools: { search, write, deploy },
  maxSteps: 10,
});
```

## ‚öôÔ∏è Options

| Option           | Type     | Default     | Description                         |
| ---------------- | -------- | ----------- | ----------------------------------- |
| `maxRecommended` | `number` | `undefined` | Warn if maxSteps exceeds this value |

## üõ°Ô∏è Why This Matters

Unbounded tool loops can cause:

- **Infinite loops** - AI keeps calling tools forever
- **Cost explosion** - Each tool call may trigger additional API calls
- **Resource exhaustion** - Downstream services overwhelmed
- **Data corruption** - Repeated mutations without checks

## üîó Related Rules

- [`require-max-tokens`](./require-max-tokens.md) - Limit token consumption
- [`require-tool-confirmation`](./require-tool-confirmation.md) - Require confirmation

## Known False Negatives

The following patterns are **not detected** due to static analysis limitations:

### Options from Variable

**Why**: Options stored in variables are not analyzed.

```typescript
// ‚ùå NOT DETECTED - Options from variable
const opts = { model: openai('gpt-4'), tools, prompt: 'Hello' }; // No maxSteps
await generateText(opts);
```

**Mitigation**: Use inline options. Always specify maxSteps with tools.

### Tools from Variable

**Why**: Tools added from variables may not trigger detection.

```typescript
// ‚ùå NOT DETECTED - Tools from variable
const tools = getToolset();
await generateText({ ..., tools }); // Has tools, needs maxSteps
```

**Mitigation**: Always set maxSteps when using tools.

### Conditional Tool Usage

**Why**: Conditionally added tools may not be detected.

```typescript
// ‚ùå NOT DETECTED - Conditional tools
const options = { model, prompt };
if (useTools) options.tools = toolset; // maxSteps also needed!
await generateText(options);
```

**Mitigation**: Set maxSteps whenever tools may be used.

### Wrapper Functions

**Why**: Custom wrappers may hide tool usage.

```typescript
// ‚ùå NOT DETECTED - Wrapper with tools
await myAgentGenerate(prompt); // Wrapper adds tools internally
```

**Mitigation**: Apply rule to wrapper implementations.

## üìö References

- [OWASP LLM10: Unbounded Consumption](https://owasp.org/www-project-top-10-for-large-language-model-applications/)
- [CWE-834: Excessive Iteration](https://cwe.mitre.org/data/definitions/834.html)
- [Vercel AI SDK Multi-step Agents](https://sdk.vercel.ai/docs/ai-sdk-core/tools)
