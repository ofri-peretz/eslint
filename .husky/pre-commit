#!/bin/bash
# Ensure nvm-installed node/pnpm is in PATH
export PATH="$HOME/.nvm/versions/node/v20.19.5/bin:$PATH"

# Skip silently if no staged changes in packages (docs, configs don't need checks)
if ! git diff --cached --name-only | grep -q "^packages/"; then
  exit 0
fi

echo "ğŸš€ Running pre-commit checks..."

# Get affected projects based on staged changes (uncommitted)
# Using --uncommitted ensures we check what's actually being committed
# Using --output-style=static prevents VS Code output overload (no dynamic rewrites)

# Run lint first (faster, catches most issues)
echo "ğŸ“ Running lint..."
LINT_OUTPUT=$(pnpm nx affected -t lint \
  --uncommitted \
  --parallel=4 \
  --output-style=static 2>&1)
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‹ Affected projects detected:"
  pnpm nx show projects --affected --uncommitted 2>/dev/null | head -20
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "$LINT_OUTPUT" | tail -50
  echo "âŒ Lint failed"
  echo ""
  echo "ğŸ’¡ Tip: Run 'pnpm nx affected -t lint --uncommitted' to see full output"
  exit 1
fi

# Show minimal lint summary (last few lines)
echo "$LINT_OUTPUT" | grep -E "(Successfully|passed|warning|error)" | tail -5

# Run tests (only if lint passes)
echo "ğŸ§ª Running tests..."
TEST_OUTPUT=$(pnpm nx affected -t test \
  --uncommitted \
  --parallel=4 \
  --output-style=static 2>&1)
TEST_EXIT=$?

if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‹ Affected projects detected:"
  pnpm nx show projects --affected --uncommitted 2>/dev/null | head -20
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "$TEST_OUTPUT" | tail -100
  echo "âŒ Tests failed"
  echo ""
  echo "ğŸ’¡ Tip: Run 'pnpm nx affected -t test --uncommitted' to see full output"
  exit 1
fi

# Show minimal test summary
echo "$TEST_OUTPUT" | grep -E "(Test Files|Tests|passed|failed)" | tail -5

echo "âœ… All checks passed!"
exit 0
