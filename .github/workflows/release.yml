# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release Package

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UNIFIED RELEASE WORKFLOW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Single workflow to release packages in the monorepo.
# - Select a specific package OR
# - Select "all-affected" to release all packages with changes since last release
#
# Dependency Order: @interlace/eslint-devkit is ALWAYS released first when affected,
# since other packages depend on it.
#
# Trigger: Manual only (workflow_dispatch)
# Branch: main only
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NPM AUTHENTICATION STRATEGY (2025+)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PRIORITY 1: NPM Trusted Publishers (OIDC - Recommended for existing packages)
#   - Requires: id-token: write permission
#   - Requires: Package already exists on npm with Trusted Publisher configured
#   - Setup: npm.js.com â†’ Package Settings â†’ Publishing access â†’ Add GitHub Actions
#   - Uses GitHub OIDC to mint short-lived tokens (no secrets needed)
#   - Publishes with provenance attestation
#
# PRIORITY 2: NPM_TOKEN (Legacy - Required for first-release)
#   - Required for NEW packages that don't exist on npm yet
#   - After first publish, configure Trusted Publishers and remove token
#   - Uses Granular Access Token with minimal scopes
#
# FIRST RELEASE FLOW:
#   1. Workflow detects package doesn't exist on npm (404)
#   2. Uses NPM_TOKEN + --first-release flag for initial publish
#   3. After success, go to npmjs.com and configure Trusted Publishers
#   4. Future releases use OIDC (no token needed)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release (all-affected = release all changed packages)"
        required: false
        type: string
        default: "all-affected"

      version-specifier:
        description: "Version bump strategy (auto = conventional commits)"
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
          - premajor
          - preminor
          - prepatch
          - prerelease
        default: "auto"

      dist-tag:
        description: "NPM distribution tag"
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
          - rc
          - alpha
        default: "latest"

      run-ci:
        description: "Run CI validation (usually not needed - main already passed CI)"
        required: false
        type: boolean
        default: false

      dry-run:
        description: "Dry run: preview changes without modifying git or NPM"
        required: false
        type: boolean
        default: false

      force-version:
        description: "Force specific version (e.g., 3.1.0) - overrides version-specifier"
        required: false
        type: string
        default: ""

      generate-changelog:
        description: "Generate changelog (creates GitHub release)"
        required: false
        type: boolean
        default: true

      first-time-only:
        description: "Release ONLY packages that do not exist on npm yet"
        required: false
        type: boolean
        default: false

# Prevent concurrent release runs
concurrency:
  group: release-workflow
  cancel-in-progress: false

env:
  NODE_VERSION: "24"
  # Dependency order: devkit MUST be first since others depend on it
  # This array defines the release sequence for all-affected mode
  DEPENDENCY_ORDER: "eslint-devkit,eslint-plugin-secure-coding,eslint-plugin-crypto,eslint-plugin-jwt,eslint-plugin-pg,eslint-plugin-mongodb-security,eslint-plugin-express-security,eslint-plugin-nestjs-security,eslint-plugin-browser-security,eslint-plugin-lambda-security,eslint-plugin-vercel-ai-security,eslint-plugin-node-security,eslint-plugin-conventions,eslint-plugin-maintainability,eslint-plugin-modularity,eslint-plugin-modernization,eslint-plugin-reliability,eslint-plugin-operability,eslint-plugin-react-a11y,eslint-plugin-react-features,eslint-plugin-import-next"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: DETECT AFFECTED PACKAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-affected:
    name: ðŸ” Detect Affected Packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      package-count: ${{ steps.detect.outputs.package-count }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: main

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§¹ Clean up orphaned tags
        id: cleanup-tags
        run: |
          echo "ðŸ§¹ Checking for orphaned tags (git tag exists but npm version doesn't)..."
          echo ""

          ORPHANED_TAGS=""
          CLEANED_COUNT=0

          # Check all publishable packages
          for pkg in eslint-devkit eslint-plugin-secure-coding eslint-plugin-crypto eslint-plugin-jwt eslint-plugin-pg eslint-plugin-mongodb-security eslint-plugin-express-security eslint-plugin-nestjs-security eslint-plugin-browser-security eslint-plugin-lambda-security eslint-plugin-vercel-ai-security eslint-plugin-node-security eslint-plugin-conventions eslint-plugin-maintainability eslint-plugin-modularity eslint-plugin-modernization eslint-plugin-reliability eslint-plugin-operability eslint-plugin-react-a11y eslint-plugin-react-features eslint-plugin-import-next; do
            # Resolve npm package name
            case "$pkg" in
              eslint-devkit) NPM_NAME="@interlace/eslint-devkit" ;;
              *) NPM_NAME="$pkg" ;;
            esac
            
            # Get local version from package.json
            LOCAL_VER=$(node -p "require('./packages/$pkg/package.json').version" 2>/dev/null || echo "")
            if [ -z "$LOCAL_VER" ]; then
              continue
            fi
            
            EXPECTED_TAG="${pkg}@${LOCAL_VER}"
            
            # Check if git tag exists
            if git rev-parse "$EXPECTED_TAG" >/dev/null 2>&1; then
              # Check if npm version exists
              NPM_VER=$(npm view "$NPM_NAME@$LOCAL_VER" version 2>/dev/null || echo "")
              
              if [ -z "$NPM_VER" ]; then
                echo "ðŸ—‘ï¸ ORPHANED TAG FOUND: $EXPECTED_TAG"
                echo "   â””â”€ Git tag exists but npm version $NPM_NAME@$LOCAL_VER does not exist"
                echo "   â””â”€ Deleting local and remote tag..."
                
                # Delete local tag
                git tag -d "$EXPECTED_TAG" 2>/dev/null || true
                
                # Delete remote tag
                git push origin ":refs/tags/$EXPECTED_TAG" 2>/dev/null || true
                
                echo "   âœ… Deleted orphaned tag: $EXPECTED_TAG"
                ORPHANED_TAGS="$ORPHANED_TAGS $EXPECTED_TAG"
                CLEANED_COUNT=$((CLEANED_COUNT + 1))
              fi
            fi
          done

          if [ $CLEANED_COUNT -gt 0 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ§¹ ORPHANED TAG CLEANUP SUMMARY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Deleted $CLEANED_COUNT orphaned tag(s):$ORPHANED_TAGS"
            echo "These tags existed in git but their versions were never published to npm."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "âœ… No orphaned tags found"
          fi

          echo "orphaned-count=$CLEANED_COUNT" >> $GITHUB_OUTPUT
          echo "orphaned-tags=$ORPHANED_TAGS" >> $GITHUB_OUTPUT

      - name: ðŸ” Detect packages to release
        id: detect
        run: |
          SELECTED="${{ inputs.package }}"

          if [ "$SELECTED" = "all-affected" ]; then
            echo "ðŸ” Detecting all affected packages..."
            
            # Find the last release tag to compare against
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            
            if [ -z "$LAST_TAG" ]; then
              echo "âš ï¸ No previous tags found, checking all packages"
              BASE="HEAD~10"
            else
              echo "ðŸ“Œ Comparing against last tag: $LAST_TAG"
              BASE="$LAST_TAG"
            fi
            
            # Get affected projects using Nx
            AFFECTED=$(npx nx show projects --affected --base=$BASE --head=HEAD 2>/dev/null || echo "")
            
            # Filter to only publishable packages (in packages/ directory)
            # Note: The release loop handles version bumping and skip logic
            # Here we just filter Nx affected to publishable packages
            PUBLISHABLE_PACKAGES=""
            for pkg in eslint-devkit eslint-plugin-secure-coding eslint-plugin-crypto eslint-plugin-jwt eslint-plugin-pg eslint-plugin-mongodb-security eslint-plugin-express-security eslint-plugin-nestjs-security eslint-plugin-browser-security eslint-plugin-lambda-security eslint-plugin-vercel-ai-security eslint-plugin-node-security eslint-plugin-conventions eslint-plugin-maintainability eslint-plugin-modularity eslint-plugin-modernization eslint-plugin-reliability eslint-plugin-operability eslint-plugin-react-a11y eslint-plugin-react-features eslint-plugin-import-next; do
              if echo "$AFFECTED" | grep -q "^$pkg$"; then
                # Verify package.json exists
                if [ ! -f "./packages/$pkg/package.json" ]; then
                  echo "âš ï¸ Skipping $pkg (no package.json)"
                  continue
                fi
                
                if [ -z "$PUBLISHABLE_PACKAGES" ]; then
                  PUBLISHABLE_PACKAGES="$pkg"
                else
                  PUBLISHABLE_PACKAGES="$PUBLISHABLE_PACKAGES,$pkg"
                fi
              fi
            done
            
            # If eslint-devkit is affected, ensure it's first (dependency order)
            if echo "$PUBLISHABLE_PACKAGES" | grep -q "eslint-devkit"; then
              # Remove devkit from wherever it is
              OTHERS=$(echo "$PUBLISHABLE_PACKAGES" | sed 's/eslint-devkit,//g' | sed 's/,eslint-devkit//g' | sed 's/^eslint-devkit$//g')
              if [ -n "$OTHERS" ]; then
                PUBLISHABLE_PACKAGES="eslint-devkit,$OTHERS"
              else
                PUBLISHABLE_PACKAGES="eslint-devkit"
              fi
            fi
            
            if [ -z "$PUBLISHABLE_PACKAGES" ]; then
              echo "â„¹ï¸ No affected packages found"
              echo "packages=" >> $GITHUB_OUTPUT
              echo "package-count=0" >> $GITHUB_OUTPUT
              echo "matrix={\"package\":[]}" >> $GITHUB_OUTPUT
            else
              echo "ðŸ“¦ Affected packages (in dependency order): $PUBLISHABLE_PACKAGES"
              echo "packages=$PUBLISHABLE_PACKAGES" >> $GITHUB_OUTPUT
              
              # Count packages
              COUNT=$(echo "$PUBLISHABLE_PACKAGES" | tr ',' '\n' | wc -l | tr -d ' ')
              echo "package-count=$COUNT" >> $GITHUB_OUTPUT
              
              # Create matrix JSON (compact, single-line for GitHub Actions)
              MATRIX_JSON=$(echo "$PUBLISHABLE_PACKAGES" | tr ',' '\n' | jq -R . | jq -sc '{package: .}')
              echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ“¦ Single package selected: $SELECTED"
            echo "packages=$SELECTED" >> $GITHUB_OUTPUT
            echo "package-count=1" >> $GITHUB_OUTPUT
            echo "matrix={\"package\":[\"$SELECTED\"]}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ” Package Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VERSION_SPEC="${{ inputs.version-specifier }}"

          if [ "${{ steps.detect.outputs.package-count }}" = "0" ]; then
            echo "â„¹ï¸ No packages to release" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Version Specifier:** \`$VERSION_SPEC\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Current | Bump | Commits Since Release |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|------|----------------------|" >> $GITHUB_STEP_SUMMARY
            
            echo "${{ steps.detect.outputs.packages }}" | tr ',' '\n' | while read pkg; do
              if [ -n "$pkg" ]; then
                # Get current version
                CURRENT_VER=$(node -p "require('./packages/$pkg/package.json').version" 2>/dev/null || echo "N/A")
                
                # Resolve NPM name
                case "$pkg" in
                  eslint-devkit) NPM_NAME="@interlace/eslint-devkit" ;;
                  *) NPM_NAME="$pkg" ;;
                esac
                
                # Check if this is a first-time release
                IS_FIRST_RELEASE=false
                NPM_CHECK=$(npm view "$NPM_NAME" version 2>&1) || true
                if echo "$NPM_CHECK" | grep -qiE "(404|not found|no such package)"; then
                  IS_FIRST_RELEASE=true
                fi
                
                # Find last tag for this package
                LAST_TAG=$(git tag --list "${pkg}@*" --sort=-version:refname 2>/dev/null | head -1 || echo "")
                
                # Count commits since last tag for this package
                if [ -n "$LAST_TAG" ]; then
                  COMMIT_COUNT=$(git log --oneline "$LAST_TAG..HEAD" -- "packages/$pkg/" 2>/dev/null | wc -l | tr -d ' ')
                elif [ "$IS_FIRST_RELEASE" = "true" ]; then
                  COMMIT_COUNT="ðŸ†• First Release"
                else
                  COMMIT_COUNT="(no tag)"
                fi
                
                # Determine bump type
                if [ "$IS_FIRST_RELEASE" = "true" ]; then
                  BUMP="ðŸ†• initial"
                elif [ "$VERSION_SPEC" = "auto" ]; then
                  # Check if there's a feat commit (minor) or just fix (patch)
                  if [ -n "$LAST_TAG" ] && git log --oneline "$LAST_TAG..HEAD" -- "packages/$pkg/" 2>/dev/null | grep -qE "^[a-f0-9]+ feat"; then
                    BUMP="minor â¬†ï¸"
                  else
                    BUMP="patch ðŸ”§"
                  fi
                else
                  BUMP="$VERSION_SPEC ðŸ“¦"
                fi
                
                echo "| \`$pkg\` | \`$CURRENT_VER\` | $BUMP | $COMMIT_COUNT |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Recent Commits per Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "${{ steps.detect.outputs.packages }}" | tr ',' '\n' | while read pkg; do
              if [ -n "$pkg" ]; then
                LAST_TAG=$(git tag --list "${pkg}@*" --sort=-version:refname 2>/dev/null | head -1 || echo "")
                echo "**$pkg**" >> $GITHUB_STEP_SUMMARY
                if [ -n "$LAST_TAG" ]; then
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  git log --oneline "$LAST_TAG..HEAD" -- "packages/$pkg/" 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "No commits found" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                else
                  echo "(No release tag found)" >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: RELEASE PACKAGES (Sequential to respect dependencies)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸš€ Release
    needs: detect-affected
    if: needs.detect-affected.outputs.package-count != '0'
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60
    permissions:
      contents: write
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: â¬†ï¸ Upgrade npm for Trusted Publishers
        run: |
          echo "ðŸ“¦ Upgrading npm to 11+ for Trusted Publishers OIDC support..."
          npm install -g npm@latest
          echo "âœ… npm version: $(npm --version)"

      - name: ðŸ—„ï¸ Restore NX cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nx-cache-${{ runner.os }}-

      - name: ðŸ” Verify NPM Authentication
        if: inputs.dry-run == false
        id: npm-auth
        run: |
          echo "ðŸ” Verifying NPM authentication setup..."
          echo ""

          # For Trusted Publishers, no NPM_TOKEN is needed
          # The OIDC token is minted at publish time by npm
          # NPM_TOKEN is only needed for first-release packages

          HAS_TOKEN=false
          if [ -n "$NPM_TOKEN" ]; then
            HAS_TOKEN=true
            echo "âœ… NPM_TOKEN is configured (will be used for any first-release packages)"
            
          # Try to verify token validity (filter out npm warnings)
            AUTH_OUTPUT=$(npm whoami --registry=https://registry.npmjs.org/ 2>&1) || true
            # Extract just the username (last line that's a valid username, not a warning)
            AUTH_USER=$(echo "$AUTH_OUTPUT" | grep -v "^npm " | grep -v "^$" | tail -1)
            
            if [ -n "$AUTH_USER" ] && ! echo "$AUTH_USER" | grep -qiE "(error|unauthorized|401)"; then
              echo "âœ… NPM_TOKEN verified - authenticated as: $AUTH_USER"
              # Sanitize output for GitHub Actions (only alphanumeric and hyphens)
              SAFE_USER=$(echo "$AUTH_USER" | tr -cd '[:alnum:]-_')
              echo "npm-user=$SAFE_USER" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ NPM_TOKEN may be invalid (npm whoami failed)"
              echo "   â””â”€ This is OK if all packages use Trusted Publishers"
              echo "   â””â”€ First-release packages will fail without a valid token"
            fi
          else
            echo "â„¹ï¸ No NPM_TOKEN configured"
            echo "   â””â”€ Existing packages: Will use Trusted Publishers (OIDC)"
            echo "   â””â”€ First-release packages: Will FAIL (token required)"
          fi

          echo "has-token=$HAS_TOKEN" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“¦ Publishing will proceed using:"
          echo "   â€¢ Trusted Publishers (OIDC) for existing packages"
          if [ "$HAS_TOKEN" = "true" ]; then
            echo "   â€¢ NPM_TOKEN for first-release packages"
          else
            echo "   â€¢ âš ï¸ NPM_TOKEN NOT available for first-release packages"
          fi
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # RELEASE LOOP - Sequential to respect dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # NOTE: Release logic is in .github/scripts/release-packages.sh
      # This was extracted to avoid GitHub Actions' 21KB expression limit (R17)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Release Packages (Sequential)
        id: release-all
        run: .github/scripts/release-packages.sh
        env:
          PACKAGES: ${{ needs.detect-affected.outputs.packages }}
          DRY_RUN: ${{ inputs.dry-run }}
          VERSION_SPEC: ${{ inputs.version-specifier }}
          DIST_TAG: ${{ inputs.dist-tag }}
          FORCE_VERSION: ${{ inputs.force-version }}
          GENERATE_CHANGELOG: ${{ inputs.generate-changelog }}
          RUN_CI: ${{ inputs.run-ci }}
          FIRST_TIME_ONLY: ${{ inputs.first-time-only }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NX_SKIP_NX_CLOUD: "true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generate Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry-run }}" = "true" ]; then
            echo "### ðŸ” Dry Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "No changes were made." >> $GITHUB_STEP_SUMMARY
          else
            RELEASED="${{ steps.release-all.outputs.released }}"
            SKIPPED="${{ steps.release-all.outputs.skipped }}"
            FAILED="${{ steps.release-all.outputs.failed }}"
            FAILED_DETAILS="${{ steps.release-all.outputs.failed-details }}"
            
            # Count results
            RELEASED_COUNT=0
            SKIPPED_COUNT=0
            FAILED_COUNT=0
            
            if [ -n "$RELEASED" ]; then
              RELEASED_COUNT=$(echo "$RELEASED" | wc -w | tr -d ' ')
            fi
            if [ -n "$SKIPPED" ]; then
              SKIPPED_COUNT=$(echo "$SKIPPED" | wc -w | tr -d ' ')
            fi
            if [ -n "$FAILED" ]; then
              FAILED_COUNT=$(echo "$FAILED" | wc -w | tr -d ' ')
            fi
            
            TOTAL=$(($RELEASED_COUNT + $SKIPPED_COUNT + $FAILED_COUNT))
            
            echo "**Total Packages Processed:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Published | $RELEASED_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$RELEASED" ]; then
              echo "### âœ… Successfully Published" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Package | Version | NPM Link |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|---------|----------|" >> $GITHUB_STEP_SUMMARY
              for pkg_ver in $RELEASED; do
                # Extract package and version
                PKG="${pkg_ver%@*}"
                VER="${pkg_ver##*@}"
                
                # Resolve NPM name
                case "$PKG" in
                  eslint-devkit) NPM_NAME="@interlace/eslint-devkit" ;;
                  *) NPM_NAME="$PKG" ;;
                esac
                
                echo "| \`$PKG\` | \`$VER\` | [npm](https://www.npmjs.com/package/$NPM_NAME/v/$VER) |" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "$SKIPPED" ]; then
              echo "### â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              for pkg in $SKIPPED; do
                # Check if it contains a reason (format: package(reason))
                if echo "$pkg" | grep -q '('; then
                  PKG="${pkg%%(*}"
                  REASON="${pkg#*'('}"
                  REASON="${REASON%')'}"
                  echo "- \`$PKG\` - $REASON" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- \`$pkg\`" >> $GITHUB_STEP_SUMMARY
                fi
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "$FAILED" ]; then
              echo "### âŒ Failed Packages" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              for pkg in $FAILED; do
                echo "- \`$pkg\`" >> $GITHUB_STEP_SUMMARY
              done
              
              if [ -n "$FAILED_DETAILS" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "<details>" >> $GITHUB_STEP_SUMMARY
                echo "<summary>ðŸ“‹ Failure Details</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "$FAILED_DETAILS" | sed 's/%0A/\n/g' >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
