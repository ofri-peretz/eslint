# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SDK Compatibility: PostgreSQL (pg)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Proactively detect breaking changes in the 'pg' Node.js PostgreSQL driver
# that could affect eslint-plugin-pg rules.
#
# WHAT IT DOES:
# 1. Installs the LATEST version of 'pg' (not what's in lockfile)
# 2. Runs comprehensive interface compatibility tests
# 3. Compares against plugin's declared peerDependency version
# 4. If tests fail, creates a GitHub Issue with LLM-friendly report
#
# SCHEDULE: Every Monday at 6 AM UTC
#
# MANUAL TRIGGER: workflow_dispatch for ad-hoc testing
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "SDK: PostgreSQL (pg)"

on:
  schedule:
    # Every Monday at 6 AM UTC
    - cron: "0 6 * * 1"

  workflow_dispatch:
    inputs:
      pg_version:
        description: "Specific pg version to test (leave empty for latest)"
        required: false
        default: ""
      create_issue:
        description: "Create GitHub issue on failure"
        type: boolean
        default: true

env:
  NODE_VERSION: "24"
  PLUGIN_PATH: "packages/eslint-plugin-pg"
  SDK_PACKAGE: "pg"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COMPATIBILITY TEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  compatibility:
    name: pg Compatibility Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      test_passed: ${{ steps.test.outputs.passed }}
      sdk_version: ${{ steps.versions.outputs.latest }}
      peer_dep: ${{ steps.versions.outputs.peer_dep }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION DISCOVERY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ” Get version information
        id: versions
        run: |
          # Get latest version from npm
          if [ -n "${{ inputs.pg_version }}" ]; then
            LATEST="${{ inputs.pg_version }}"
          else
            LATEST=$(npm view ${{ env.SDK_PACKAGE }} version)
          fi
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Latest pg version: $LATEST"

          # Get current peer dependency from package.json
          PEER_DEP=$(jq -r '.peerDependencies.pg // "not specified"' ${{ env.PLUGIN_PATH }}/package.json)
          echo "peer_dep=$PEER_DEP" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Plugin peerDependency: $PEER_DEP"

          # Get currently installed version
          INSTALLED=$(jq -r '.version' node_modules/pg/package.json 2>/dev/null || echo "not installed")
          echo "installed=$INSTALLED" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Currently installed: $INSTALLED"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # INSTALL LATEST SDK VERSION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ”„ Install latest pg version
        run: |
          echo "ğŸ”„ Installing pg@${{ steps.versions.outputs.latest }}..."
          # Install at workspace root (proper monorepo pattern)
          npm install ${{ env.SDK_PACKAGE }}@${{ steps.versions.outputs.latest }} --save-dev

          # Verify installation
          ACTUAL=$(node -e "console.log(require('pg/package.json').version)")
          echo "âœ… Installed pg@${ACTUAL}"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # RUN COMPATIBILITY TESTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ§ª Run Interface Compatibility Tests
        id: test
        continue-on-error: true
        run: |
          # Create output directory at plugin path
          mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

          # Run tests from workspace root with explicit file path
          set +e
          npx vitest run \
            --reporter=verbose \
            --reporter=json \
            --outputFile=${{ env.PLUGIN_PATH }}/.compatibility-results/test-results.json \
            "${{ env.PLUGIN_PATH }}/src/__compatibility__/**/*.spec.ts" 2>&1 | tee ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt

          TEST_EXIT_CODE=$?
          set -e

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All compatibility tests passed!"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Compatibility tests failed with exit code: $TEST_EXIT_CODE"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GENERATE LLM-FRIENDLY REPORT (on failure)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“ Generate Compatibility Report
        if: steps.test.outputs.passed == 'false'
        run: |
          mkdir -p .compatibility-results

          cat << 'REPORT_HEADER' > .compatibility-results/BREAKING_CHANGE_REPORT.md
          # ğŸš¨ pg SDK Breaking Change Report

          ## Summary

          The eslint-plugin-pg interface compatibility tests have FAILED against the latest pg version.
          This indicates a potential breaking change that may affect ESLint rules.

          REPORT_HEADER

          cat << EOF >> .compatibility-results/BREAKING_CHANGE_REPORT.md
          ## Version Information

          | Property | Value |
          |----------|-------|
          | **SDK Tested** | pg@${{ steps.versions.outputs.latest }} |
          | **Plugin peerDep** | ${{ steps.versions.outputs.peer_dep }} |
          | **Test Date** | $(date -u +"%Y-%m-%d %H:%M UTC") |
          | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

          ## Test Failures

          \`\`\`
          $(grep -A 50 "FAIL" ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt | head -100 || echo "No FAIL output captured")
          \`\`\`

          ## Files to Review

          1. **Compatibility Tests**: \`${{ env.PLUGIN_PATH }}/src/__compatibility__/pg-interface.spec.ts\`
          2. **Plugin Rules**: \`${{ env.PLUGIN_PATH }}/src/rules/\`
          3. **Package Config**: \`${{ env.PLUGIN_PATH }}/package.json\`

          ## Required Actions

          ### For LLM/Agent Processing:

          1. **Analyze the failure**: Identify which interface/method/property has changed
          2. **Check pg changelog**: Review https://github.com/brianc/node-postgres/releases for v${{ steps.versions.outputs.latest }}
          3. **Update compatibility tests**: If the change is intentional, update the test expectations
          4. **Review affected rules**: Check if any ESLint rules need updates for the new API
          5. **Update peerDependencies**: If this is a major version bump, update package.json

          ### Affected Rules by Interface:

          | Interface | Rules That May Need Updates |
          |-----------|----------------------------|
          | Client.query() | no-unsafe-query, check-query-params, no-select-all |
          | Pool.connect() | no-missing-client-release, prefer-pool-query |
          | Client.release() | no-missing-client-release, prevent-double-release |
          | SSL config | no-insecure-ssl |
          | Connection config | no-hardcoded-credentials |
          | COPY syntax | no-unsafe-copy-from |
          | SET commands | no-unsafe-search-path |

          ## Full Test Output

          <details>
          <summary>Click to expand full test output</summary>

          \`\`\`
          $(cat ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt)
          \`\`\`

          </details>
          EOF

          echo "ğŸ“ Report generated at .compatibility-results/BREAKING_CHANGE_REPORT.md"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPLOAD ARTIFACTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“¤ Upload Compatibility Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pg-compatibility-results
          path: ${{ env.PLUGIN_PATH }}/.compatibility-results/
          retention-days: 30

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # WORKFLOW SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“Š Generate Workflow Summary
        if: always()
        run: |
          echo "## ğŸ”¬ pg SDK Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **SDK Version** | pg@${{ steps.versions.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Plugin peerDep** | ${{ steps.versions.outputs.peer_dep }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.passed }}" == "true" ]; then
            echo "| **Status** | âœ… **COMPATIBLE** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All interface compatibility tests passed. No breaking changes detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | âŒ **BREAKING CHANGES DETECTED** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action Required**: Review the compatibility report in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ISSUE ON FAILURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-issue:
    name: Create Issue for Breaking Changes
    needs: compatibility
    runs-on: ubuntu-latest
    if: needs.compatibility.outputs.test_passed == 'false' && (github.event.inputs.create_issue != 'false' || github.event_name == 'schedule')

    steps:
      - name: ğŸ“¥ Download Compatibility Report
        uses: actions/download-artifact@v4
        with:
          name: pg-compatibility-results
          path: report/

      - name: ğŸš¨ Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the detailed report
            let reportBody = '';
            try {
              reportBody = fs.readFileSync('report/BREAKING_CHANGE_REPORT.md', 'utf8');
            } catch (e) {
              reportBody = `## pg SDK Breaking Change Detected
              
              The compatibility tests failed for pg@${{ needs.compatibility.outputs.sdk_version }}.
              
              See workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            }

            // Check for existing open issues to avoid duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility,pg',
              per_page: 5
            });

            const duplicateIssue = existingIssues.data.find(issue => 
              issue.title.includes('pg@${{ needs.compatibility.outputs.sdk_version }}')
            );

            if (duplicateIssue) {
              console.log(`Issue already exists: #${duplicateIssue.number}`);
              
              // Add a comment with the new run info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `ğŸ”„ **Compatibility check re-run** on ${new Date().toISOString()}\n\nSee latest run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ [SDK Compatibility] pg@${{ needs.compatibility.outputs.sdk_version }} Breaking Changes`,
                body: reportBody,
                labels: ['sdk-compatibility', 'pg', 'maintenance', 'breaking-change']
              });
              
              console.log(`Created issue: #${issue.data.number}`);
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUCCESS NOTIFICATION (optional cleanup)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  success-cleanup:
    name: Success Cleanup
    needs: compatibility
    runs-on: ubuntu-latest
    if: needs.compatibility.outputs.test_passed == 'true'

    steps:
      - name: âœ… Close Resolved Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Find open issues for pg compatibility
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility,pg',
              per_page: 10
            });

            for (const issue of issues.data) {
              // Check if this issue was for an older version
              if (!issue.title.includes('pg@${{ needs.compatibility.outputs.sdk_version }}')) {
                console.log(`Closing resolved issue: #${issue.number}`);
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `âœ… **Automatically closed**: Compatibility tests now pass for pg@${{ needs.compatibility.outputs.sdk_version }}.`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
              }
            }
