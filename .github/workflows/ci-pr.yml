name: CI Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "!README.md"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
  workflow_dispatch:

# Prevent concurrent runs on the same branch to save quota
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CI: Test, Build, Typecheck affected packages
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci:
    name: CI (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20, 22, 24]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # EARLY CHECK: DOCS-ONLY CHANGES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Check if changes are docs-only
        id: docs_only
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          DOCS_ONLY=true
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            if ! [[ "$file" =~ ^docs/ || "$file" =~ \.md$ || "$file" =~ README || "$file" =~ CHANGELOG ]]; then
              DOCS_ONLY=false
              break
            fi
          done <<< "$CHANGED_FILES"

          if [[ "$DOCS_ONLY" == "true" && -n "$CHANGED_FILES" ]]; then
            echo "âœ… Only documentation files changed - skipping full CI"
            echo "docs_only=true" >> $GITHUB_OUTPUT
          else
            echo "âš™ï¸ Non-docs files changed - running full CI pipeline"
            echo "docs_only=false" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Skip CI for docs-only changes
        if: steps.docs_only.outputs.docs_only == 'true'
        run: |
          echo "âœ… CI passed automatically - only documentation files were changed"
          exit 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SETUP: NODE + DEPENDENCIES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: âš™ï¸ Setup Node.js
        if: steps.docs_only.outputs.docs_only != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        if: steps.docs_only.outputs.docs_only != 'true'
        run: npm ci

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # NX CACHE - Persist build artifacts between runs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ—„ï¸ Restore NX cache
        if: steps.docs_only.outputs.docs_only != 'true'
        uses: actions/cache@v5
        with:
          path: .nx/cache
          key: nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nx-cache-${{ runner.os }}-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DERIVE AFFECTED PACKAGES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ” Derive affected packages
        if: steps.docs_only.outputs.docs_only != 'true'
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # TEST, BUILD, TYPECHECK (runs in parallel with lint workflow)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ§ª Test Affected Packages
        if: steps.docs_only.outputs.docs_only != 'true'
        run: npx nx affected -t test -c ci --verbose
        env:
          NX_SKIP_NX_CLOUD: "true"

      - name: ðŸ”¨ Build Affected Packages
        if: steps.docs_only.outputs.docs_only != 'true'
        run: npx nx affected -t build --verbose
        env:
          NX_SKIP_NX_CLOUD: "true"

      - name: ðŸ” Typecheck Affected Packages
        if: steps.docs_only.outputs.docs_only != 'true'
        run: npx nx affected -t typecheck --verbose
        env:
          NX_SKIP_NX_CLOUD: "true"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # RELEASE VALIDATION (Non-blocking early warning)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ” Validate Release (Dry-Run)
        if: steps.docs_only.outputs.docs_only != 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Release validation (non-blocking)..."
          npx nx release version --dry-run --projects=eslint-plugin-secure-coding 2>&1 || {
            echo "âš ï¸ Release dry-run detected potential issues (warning only)"
          }
        env:
          NX_SKIP_NX_CLOUD: "true"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ“Š Print CI Summary
        if: always() && steps.docs_only.outputs.docs_only != 'true'
        run: |
          echo "## ðŸ“Š CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node:** $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **npm:** $(npm --version)" >> $GITHUB_STEP_SUMMARY
