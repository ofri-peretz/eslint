# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SDK Compatibility: MongoDB (mongodb + mongoose)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Proactively detect breaking changes in the 'mongodb' and 'mongoose' packages
# that could affect eslint-plugin-mongodb-security rules.
#
# WHAT IT DOES:
# 1. Installs the LATEST versions of 'mongodb' and 'mongoose' (not what's in lockfile)
# 2. Runs comprehensive interface compatibility tests
# 3. Compares against plugin's declared peerDependency versions
# 4. If tests fail, creates a GitHub Issue with LLM-friendly report
#
# SCHEDULE: Every Monday at 6 AM UTC
#
# MANUAL TRIGGER: workflow_dispatch for ad-hoc testing
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "SDK: MongoDB"

on:
    schedule:
        # Every Monday at 6 AM UTC
        - cron: "0 6 * * 1"

    workflow_dispatch:
        inputs:
            mongodb_version:
                description: "Specific mongodb version to test (leave empty for latest)"
                required: false
                default: ""
            mongoose_version:
                description: "Specific mongoose version to test (leave empty for latest)"
                required: false
                default: ""
            create_issue:
                description: "Create GitHub issue on failure"
                type: boolean
                default: true

env:
    NODE_VERSION: "22"
    PNPM_VERSION: "10.18.3"
    PLUGIN_PATH: "packages/eslint-plugin-mongodb-security"

jobs:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # COMPATIBILITY TEST
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    compatibility:
        name: MongoDB Compatibility Test
        runs-on: ubuntu-latest
        timeout-minutes: 10

        outputs:
            test_passed: ${{ steps.test.outputs.passed }}
            mongodb_version: ${{ steps.versions.outputs.mongodb_latest }}
            mongoose_version: ${{ steps.versions.outputs.mongoose_latest }}
            mongodb_peer_dep: ${{ steps.versions.outputs.mongodb_peer_dep }}
            mongoose_peer_dep: ${{ steps.versions.outputs.mongoose_peer_dep }}

        steps:
            - name: ğŸ“¥ Checkout repository
              uses: actions/checkout@v4

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # SETUP
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: âš™ï¸ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: âš™ï¸ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: ğŸ“¦ Install dependencies
              run: pnpm install --frozen-lockfile

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # VERSION DISCOVERY
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ” Get version information
              id: versions
              run: |
                  # Get latest mongodb version from npm
                  if [ -n "${{ inputs.mongodb_version }}" ]; then
                    MONGODB_LATEST="${{ inputs.mongodb_version }}"
                  else
                    MONGODB_LATEST=$(npm view mongodb version)
                  fi
                  echo "mongodb_latest=$MONGODB_LATEST" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Latest mongodb version: $MONGODB_LATEST"

                  # Get latest mongoose version from npm
                  if [ -n "${{ inputs.mongoose_version }}" ]; then
                    MONGOOSE_LATEST="${{ inputs.mongoose_version }}"
                  else
                    MONGOOSE_LATEST=$(npm view mongoose version)
                  fi
                  echo "mongoose_latest=$MONGOOSE_LATEST" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Latest mongoose version: $MONGOOSE_LATEST"

                  # Get current peer dependencies from package.json
                  MONGODB_PEER_DEP=$(jq -r '.peerDependencies.mongodb // "not specified"' ${{ env.PLUGIN_PATH }}/package.json)
                  echo "mongodb_peer_dep=$MONGODB_PEER_DEP" >> $GITHUB_OUTPUT
                  echo "ğŸ“‹ Plugin mongodb peerDependency: $MONGODB_PEER_DEP"

                  MONGOOSE_PEER_DEP=$(jq -r '.peerDependencies.mongoose // "not specified"' ${{ env.PLUGIN_PATH }}/package.json)
                  echo "mongoose_peer_dep=$MONGOOSE_PEER_DEP" >> $GITHUB_OUTPUT
                  echo "ğŸ“‹ Plugin mongoose peerDependency: $MONGOOSE_PEER_DEP"

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # INSTALL LATEST SDK VERSIONS
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ”„ Install latest MongoDB packages
              run: |
                  echo "ğŸ”„ Installing mongodb@${{ steps.versions.outputs.mongodb_latest }}..."
                  pnpm add mongodb@${{ steps.versions.outputs.mongodb_latest }} --save-dev -w

                  echo "ğŸ”„ Installing mongoose@${{ steps.versions.outputs.mongoose_latest }}..."
                  pnpm add mongoose@${{ steps.versions.outputs.mongoose_latest }} --save-dev -w

                  # Verify installations
                  MONGODB_ACTUAL=$(node -e "console.log(require('mongodb/package.json').version)")
                  MONGOOSE_ACTUAL=$(node -e "console.log(require('mongoose/package.json').version)")
                  echo "âœ… Installed mongodb@${MONGODB_ACTUAL}, mongoose@${MONGOOSE_ACTUAL}"

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # RUN COMPATIBILITY TESTS
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ§ª Run Interface Compatibility Tests
              id: test
              continue-on-error: true
              run: |
                  # Create output directory at plugin path
                  mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

                  # Run tests from workspace root with explicit file path
                  set +e
                  pnpm vitest run \
                    --reporter=verbose \
                    --reporter=json \
                    --outputFile=${{ env.PLUGIN_PATH }}/.compatibility-results/test-results.json \
                    "${{ env.PLUGIN_PATH }}/src/__compatibility__/**/*.spec.ts" 2>&1 | tee ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt

                  TEST_EXIT_CODE=$?
                  set -e

                  if [ $TEST_EXIT_CODE -eq 0 ]; then
                    echo "passed=true" >> $GITHUB_OUTPUT
                    echo "âœ… All compatibility tests passed!"
                  else
                    echo "passed=false" >> $GITHUB_OUTPUT
                    echo "âŒ Compatibility tests failed with exit code: $TEST_EXIT_CODE"
                  fi

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # GENERATE LLM-FRIENDLY REPORT (on failure)
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ“ Generate Compatibility Report
              if: steps.test.outputs.passed == 'false'
              run: |
                  mkdir -p .compatibility-results

                  cat << 'REPORT_HEADER' > .compatibility-results/BREAKING_CHANGE_REPORT.md
                  # ğŸš¨ MongoDB SDK Breaking Change Report

                  ## Summary

                  The eslint-plugin-mongodb-security interface compatibility tests have FAILED against the latest MongoDB/Mongoose versions.
                  This indicates a potential breaking change that may affect ESLint rules.

                  REPORT_HEADER

                  cat << EOF >> .compatibility-results/BREAKING_CHANGE_REPORT.md
                  ## Version Information

                  | Property | Value |
                  |----------|-------|
                  | **mongodb Tested** | mongodb@${{ steps.versions.outputs.mongodb_latest }} |
                  | **mongoose Tested** | mongoose@${{ steps.versions.outputs.mongoose_latest }} |
                  | **mongodb peerDep** | ${{ steps.versions.outputs.mongodb_peer_dep }} |
                  | **mongoose peerDep** | ${{ steps.versions.outputs.mongoose_peer_dep }} |
                  | **Test Date** | $(date -u +"%Y-%m-%d %H:%M UTC") |
                  | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

                  ## Test Failures

                  \`\`\`
                  $(grep -A 50 "FAIL" ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt | head -100 || echo "No FAIL output captured")
                  \`\`\`

                  ## Files to Review

                  1. **Compatibility Tests**: \`${{ env.PLUGIN_PATH }}/src/__compatibility__/mongodb-interface.spec.ts\`
                  2. **Plugin Rules**: \`${{ env.PLUGIN_PATH }}/src/rules/\`
                  3. **Package Config**: \`${{ env.PLUGIN_PATH }}/package.json\`

                  ## Required Actions

                  ### For LLM/Agent Processing:

                  1. **Analyze the failure**: Identify which interface/method/property has changed
                  2. **Check changelogs**:
                     - MongoDB: https://github.com/mongodb/node-mongodb-native/releases
                     - Mongoose: https://github.com/Automattic/mongoose/releases
                  3. **Update compatibility tests**: If the change is intentional, update the test expectations
                  4. **Review affected rules**: Check if any ESLint rules need updates for the new API
                  5. **Update peerDependencies**: If this is a major version bump, update package.json

                  ### Affected Rules by Interface:

                  | Interface | Rules That May Need Updates |
                  |-----------|----------------------------|
                  | MongoClient/connect | no-hardcoded-connection-string, require-tls-connection |
                  | Collection.find/findOne | no-unsafe-query, no-operator-injection |
                  | $where operator | no-unsafe-where |
                  | $regex patterns | no-unsafe-regex-query |
                  | Schema definition | require-schema-validation |
                  | Model.populate | no-unsafe-populate |
                  | Query.select | no-select-sensitive-fields |

                  ## Full Test Output

                  <details>
                  <summary>Click to expand full test output</summary>

                  \`\`\`
                  $(cat ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt)
                  \`\`\`

                  </details>
                  EOF

                  echo "ğŸ“ Report generated at .compatibility-results/BREAKING_CHANGE_REPORT.md"

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # UPLOAD ARTIFACTS
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ“¤ Upload Compatibility Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: mongodb-compatibility-results
                  path: ${{ env.PLUGIN_PATH }}/.compatibility-results/
                  retention-days: 30

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # WORKFLOW SUMMARY
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            - name: ğŸ“Š Generate Workflow Summary
              if: always()
              run: |
                  echo "## ğŸ”¬ MongoDB SDK Compatibility Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **mongodb Version** | mongodb@${{ steps.versions.outputs.mongodb_latest }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **mongoose Version** | mongoose@${{ steps.versions.outputs.mongoose_latest }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **mongodb peerDep** | ${{ steps.versions.outputs.mongodb_peer_dep }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **mongoose peerDep** | ${{ steps.versions.outputs.mongoose_peer_dep }} |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.test.outputs.passed }}" == "true" ]; then
                    echo "| **Status** | âœ… **COMPATIBLE** |" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "All interface compatibility tests passed. No breaking changes detected." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| **Status** | âŒ **BREAKING CHANGES DETECTED** |" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "âš ï¸ **Action Required**: Review the compatibility report in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
                  fi

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CREATE ISSUE ON FAILURE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    create-issue:
        name: Create Issue for Breaking Changes
        needs: compatibility
        runs-on: ubuntu-latest
        if: needs.compatibility.outputs.test_passed == 'false' && (github.event.inputs.create_issue != 'false' || github.event_name == 'schedule')

        steps:
            - name: ğŸ“¥ Download Compatibility Report
              uses: actions/download-artifact@v4
              with:
                  name: mongodb-compatibility-results
                  path: report/

            - name: ğŸš¨ Create GitHub Issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');

                      // Read the detailed report
                      let reportBody = '';
                      try {
                        reportBody = fs.readFileSync('report/BREAKING_CHANGE_REPORT.md', 'utf8');
                      } catch (e) {
                        reportBody = `## MongoDB SDK Breaking Change Detected
                        
                        The compatibility tests failed for mongodb@${{ needs.compatibility.outputs.mongodb_version }} / mongoose@${{ needs.compatibility.outputs.mongoose_version }}.
                        
                        See workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
                      }

                      // Check for existing open issues to avoid duplicates
                      const existingIssues = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: 'sdk-compatibility,mongodb',
                        per_page: 5
                      });

                      const versionString = `mongodb@${{ needs.compatibility.outputs.mongodb_version }}`;
                      const duplicateIssue = existingIssues.data.find(issue => 
                        issue.title.includes(versionString)
                      );

                      if (duplicateIssue) {
                        console.log(`Issue already exists: #${duplicateIssue.number}`);
                        
                        // Add a comment with the new run info
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: duplicateIssue.number,
                          body: `ğŸ”„ **Compatibility check re-run** on ${new Date().toISOString()}\n\nSee latest run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
                        });
                      } else {
                        // Create new issue
                        const issue = await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: `ğŸš¨ [SDK Compatibility] mongodb@${{ needs.compatibility.outputs.mongodb_version }} / mongoose@${{ needs.compatibility.outputs.mongoose_version }} Breaking Changes`,
                          body: reportBody,
                          labels: ['sdk-compatibility', 'mongodb', 'maintenance', 'breaking-change']
                        });
                        
                        console.log(`Created issue: #${issue.data.number}`);
                      }

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SUCCESS NOTIFICATION (optional cleanup)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    success-cleanup:
        name: Success Cleanup
        needs: compatibility
        runs-on: ubuntu-latest
        if: needs.compatibility.outputs.test_passed == 'true'

        steps:
            - name: âœ… Close Resolved Issues
              uses: actions/github-script@v7
              with:
                  script: |
                      // Find open issues for MongoDB compatibility
                      const issues = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: 'sdk-compatibility,mongodb',
                        per_page: 10
                      });

                      for (const issue of issues.data) {
                        console.log(`Closing resolved issue: #${issue.number}`);
                        
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          body: `âœ… **Automatically closed**: Compatibility tests now pass for mongodb@${{ needs.compatibility.outputs.mongodb_version }} / mongoose@${{ needs.compatibility.outputs.mongoose_version }}.`
                        });
                        
                        await github.rest.issues.update({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          state: 'closed'
                        });
                      }
