# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Upload Coverage to Codecov

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW PURPOSE: Upload test coverage stats to Codecov for Nx Monorepo
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This workflow runs all tests with coverage enabled and uploads the results
# to Codecov for tracking and badge generation using Components for monorepo support.
#
# Trigger: Manual (workflow_dispatch) or weekly schedule
# Required Secret: CODECOV_TOKEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      project:
        description: "Project to test (leave empty for all)"
        required: false
        type: string
        default: ""
  schedule:
    # Run weekly on Monday at 6 AM UTC to keep coverage fresh
    - cron: "0 6 * * 1"

# Prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "24"

jobs:
  coverage:
    name: ðŸ“Š Test Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—„ï¸ Restore NX cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nx-cache-${{ runner.os }}-

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # RUN TESTS WITH COVERAGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ§ª Run Tests with Coverage
        id: tests
        continue-on-error: true
        run: |
          PROJECT="${{ inputs.project }}"

          # Validate project input if provided
          if [ -n "$PROJECT" ]; then
            if ! npx nx show project "$PROJECT" >/dev/null 2>&1; then
              echo "âŒ Invalid project: $PROJECT"
              echo "Available projects:"
              npx nx show projects
              exit 1
            fi
            echo "ðŸ“Š Running tests with coverage for: $PROJECT"
            npx nx test "$PROJECT" -c ci --coverage --verbose || echo "âš ï¸ Tests completed with issues"
          else
            echo "ðŸ“Š Running tests with coverage for all packages..."
            npx nx run-many -t test --all -c ci --coverage --verbose --nxBail=false || echo "âš ï¸ Some tests may have failed"
          fi
        env:
          NX_SKIP_NX_CLOUD: "true"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # UPLOAD TO CODECOV USING CLI (Recommended for Monorepos)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ“¥ Install Codecov CLI
        run: |
          curl -Os https://cli.codecov.io/latest/linux/codecov
          chmod +x codecov

      - name: ðŸ” Find coverage files
        id: find-coverage
        run: |
          echo "ðŸ” Searching for coverage files..."

          # Find all coverage files (lcov.info and coverage-final.json)
          LCOV_FILES=$(find . -name "lcov.info" -type f -not -path "./.nx/cache/*" 2>/dev/null | head -50)
          JSON_FILES=$(find . -name "coverage-final.json" -type f -not -path "./.nx/cache/*" 2>/dev/null | head -50)

          echo "ðŸ“ Found lcov.info files:"
          echo "$LCOV_FILES" | grep -v "^$" || echo "  (none)"

          echo ""
          echo "ðŸ“ Found coverage-final.json files:"
          echo "$JSON_FILES" | grep -v "^$" || echo "  (none)"

          if [ -n "$LCOV_FILES" ] || [ -n "$JSON_FILES" ]; then
            echo "has_coverage=true" >> $GITHUB_OUTPUT
          else
            echo "has_coverage=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No coverage files found"
          fi

      - name: ðŸ“¤ Upload coverage to Codecov
        if: steps.find-coverage.outputs.has_coverage == 'true'
        run: |
          echo "ðŸ“¤ Uploading coverage to Codecov..."
          ./codecov upload-process \
            --token ${{ secrets.CODECOV_TOKEN }} \
            --git-service github \
            --exclude .nx/cache \
            --fail-on-error || echo "âš ï¸ Codecov upload completed with warnings"
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: ðŸ§ª Upload test results to Codecov (Test Analytics)
        if: always()
        run: |
          echo "ðŸ§ª Uploading test results for Test Analytics..."
          # Find all JUnit XML files generated by vitest
          JUNIT_FILES=$(find packages -name "junit.xml" -o -name "test-report.junit.xml" 2>/dev/null | head -50)

          if [ -n "$JUNIT_FILES" ]; then
            echo "ðŸ“ Found JUnit files:"
            echo "$JUNIT_FILES"
            
            ./codecov do-upload \
              --token ${{ secrets.CODECOV_TOKEN }} \
              --report-type test_results \
              --git-service github || echo "âš ï¸ Test results upload completed with warnings"
          else
            echo "âš ï¸ No JUnit XML files found for Test Analytics"
          fi
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # COVERAGE SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ðŸ“Š Generate Coverage Summary
        if: always()
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Packages with Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List packages with coverage from packages/*/coverage
          FOUND_COVERAGE=false
          for dir in packages/*/coverage; do
            if [ -d "$dir" ] && [ -f "$dir/lcov.info" ]; then
              FOUND_COVERAGE=true
              PKG=$(echo "$dir" | cut -d'/' -f2)
              
              # Calculate coverage percentage
              LINES_FOUND=$(grep -c "^DA:" "$dir/lcov.info" 2>/dev/null || echo "0")
              LINES_HIT=$(grep "^DA:" "$dir/lcov.info" 2>/dev/null | grep -v ",0$" | wc -l | tr -d ' ' || echo "0")
              
              if [ "$LINES_FOUND" -gt 0 ]; then
                PCT=$((LINES_HIT * 100 / LINES_FOUND))
                if [ "$PCT" -ge 80 ]; then
                  EMOJI="ðŸŸ¢"
                elif [ "$PCT" -ge 60 ]; then
                  EMOJI="ðŸŸ¡"
                else
                  EMOJI="ðŸ”´"
                fi
                echo "- $EMOJI **$PKG**: ${PCT}% ($LINES_HIT/$LINES_FOUND lines)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          # Also check coverage/packages/*/
          for dir in coverage/packages/*/; do
            if [ -d "$dir" ] && [ -f "$dir/coverage-final.json" ]; then
              FOUND_COVERAGE=true
              PKG=$(echo "$dir" | cut -d'/' -f3)
              echo "- âœ… **$PKG**: coverage-final.json found" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$FOUND_COVERAGE" = "false" ]; then
            echo "âš ï¸ No coverage reports found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ [View on Codecov](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-${{ github.run_id }}
          path: |
            packages/*/coverage/
            coverage/
          retention-days: 7
          if-no-files-found: ignore
