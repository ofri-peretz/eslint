name: ESLint with Reviewdog

on:
    pull_request:
        types: [opened, synchronize, reopened]
        paths-ignore:
            - "docs/**"
            - "*.md"
            - "!README.md"
    workflow_dispatch:

# Prevent concurrent runs on the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: "24"
    PNPM_VERSION: "10.18.3"

jobs:
    lint:
        name: ESLint Review
        runs-on: ubuntu-latest
        timeout-minutes: 10
        permissions:
            contents: read
            pull-requests: write
            checks: write

        steps:
            - name: ðŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: âš™ï¸ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: âš™ï¸ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: ðŸ“¦ Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ðŸ—„ï¸ Restore NX cache
              uses: actions/cache@v4
              with:
                  path: .nx/cache
                  key: nx-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
                  restore-keys: |
                      nx-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-
                      nx-cache-${{ runner.os }}-

            - name: ðŸ—„ï¸ Restore ESLint cache
              uses: actions/cache@v4
              with:
                  path: |
                      **/.eslintcache
                      .eslintcache
                  key: eslint-cache-${{ github.ref }}-${{ github.sha }}
                  restore-keys: |
                      eslint-cache-${{ github.ref }}-
                      eslint-cache-

            - name: ðŸ” Derive affected packages
              uses: nrwl/nx-set-shas@v4
              with:
                  main-branch-name: main

            - name: ðŸ“¦ Setup reviewdog
              uses: reviewdog/action-setup@v1
              with:
                  reviewdog_version: v0.20.3

            - name: ðŸ“ Run ESLint with Reviewdog
              env:
                  REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NX_SKIP_NX_CLOUD: "true"
              run: |
                  echo "ðŸ“ Running ESLint on affected packages..."

                  # Get affected projects
                  AFFECTED=$(pnpm nx show projects --affected 2>/dev/null | tr '\n' ',' | sed 's/,$//')

                  if [ -z "$AFFECTED" ]; then
                    echo "â„¹ï¸ No affected projects detected"
                    exit 0
                  fi

                  echo "ðŸ“¦ Affected projects: $AFFECTED"

                  # Run ESLint with JSON output and pipe to reviewdog
                  # reviewdog only comments on changed lines (delta), not the entire file
                  pnpm nx affected -t lint -- --format=json --max-warnings=0 2>/dev/null | \
                    reviewdog -f=eslint -reporter=github-pr-review -filter-mode=added -fail-on-error=true || {
                      echo "âš ï¸ PR review reporter failed, trying check reporter..."
                      pnpm nx affected -t lint -- --format=json --max-warnings=0 2>/dev/null | \
                        reviewdog -f=eslint -reporter=github-pr-check -filter-mode=added -fail-on-error=true
                    }

            - name: ðŸ“Š Print Summary
              if: always()
              run: |
                  echo "## ðŸ“ ESLint Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
