# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SDK Compatibility: Vercel AI SDK
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# PURPOSE:
# Proactively detect breaking changes in the Vercel AI SDK that could affect
# eslint-plugin-vercel-ai-security rules.
#
# MONITORED PACKAGES:
# - ai (Vercel AI SDK)
# - @ai-sdk/openai (OpenAI provider)
#
# SCHEDULE: Every Monday at 6 AM UTC
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: "SDK: Vercel AI Ecosystem"

on:
  schedule:
    - cron: "0 6 * * 1"

  workflow_dispatch:
    inputs:
      create_issue:
        description: "Create GitHub issue on failure"
        type: boolean
        default: true

env:
  NODE_VERSION: "24"
  PLUGIN_PATH: "packages/eslint-plugin-vercel-ai-security"
  SDK_PACKAGE: "ai"

jobs:
  compatibility:
    name: Vercel AI Compatibility Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      test_passed: ${{ steps.test.outputs.passed }}
      sdk_version: ${{ steps.versions.outputs.latest }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Get version information
        id: versions
        run: |
          LATEST=$(npm view ${{ env.SDK_PACKAGE }} version)
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "üì¶ Latest ai version: $LATEST"

          OPENAI_LATEST=$(npm view @ai-sdk/openai version)
          echo "openai_latest=$OPENAI_LATEST" >> $GITHUB_OUTPUT
          echo "üì¶ Latest @ai-sdk/openai version: $OPENAI_LATEST"

      - name: üîÑ Install latest AI SDK version
        run: |
          # Install at workspace root (proper monorepo pattern)
          npm install ai@latest @ai-sdk/openai@latest --save-dev
          echo "‚úÖ Installed ai@${{ steps.versions.outputs.latest }}"

      - name: üß™ Run Interface Compatibility Tests
        id: test
        continue-on-error: true
        run: |
          mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

          set +e
          npx vitest run \
            --reporter=verbose \
            --reporter=json \
            --outputFile=${{ env.PLUGIN_PATH }}/.compatibility-results/test-results.json \
            "${{ env.PLUGIN_PATH }}/src/__compatibility__/**/*.spec.ts" 2>&1 | tee ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt

          TEST_EXIT_CODE=$?
          set -e

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: üìù Generate Compatibility Report
        if: steps.test.outputs.passed == 'false'
        run: |
          mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

          cat << EOF > ${{ env.PLUGIN_PATH }}/.compatibility-results/BREAKING_CHANGE_REPORT.md
          # üö® Vercel AI SDK Breaking Change Report

          ## Summary

          The eslint-plugin-vercel-ai-security interface compatibility tests have FAILED.

          ## Version Information

          | Package | Version Tested |
          |---------|----------------|
          | ai | ${{ steps.versions.outputs.latest }} |
          | @ai-sdk/openai | ${{ steps.versions.outputs.openai_latest }} |

          ## Affected Rules

          | Interface | Rules That May Need Updates |
          |-----------|----------------------------|
          | generateText() | require-system-prompt-validation, no-unsafe-tool-execution |
          | streamText() | require-stream-error-handling, no-unbounded-generation |
          | tools | require-tool-confirmation, no-dynamic-tool-names |
          | CoreMessage | require-message-sanitization |

          ## Required Actions

          1. Review Vercel AI SDK changelog
          2. Update compatibility tests
          3. Review affected ESLint rules
          4. Test with real-world examples

          EOF

      - name: üì§ Upload Compatibility Results
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: vercel-ai-compatibility-results
          path: ${{ env.PLUGIN_PATH }}/.compatibility-results/
          retention-days: 30

      - name: üìä Generate Workflow Summary
        if: always()
        run: |
          echo "## üî¨ Vercel AI SDK Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ai version** | ${{ steps.versions.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **@ai-sdk/openai** | ${{ steps.versions.outputs.openai_latest }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.passed }}" == "true" ]; then
            echo "| **Status** | ‚úÖ COMPATIBLE |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | ‚ùå BREAKING CHANGES |" >> $GITHUB_STEP_SUMMARY
          fi

  create-issue:
    name: Create Issue for Breaking Changes
    needs: compatibility
    runs-on: ubuntu-latest
    if: needs.compatibility.outputs.test_passed == 'false' && (github.event.inputs.create_issue != 'false' || github.event_name == 'schedule')

    steps:
      - name: üì• Download Compatibility Report
        uses: actions/download-artifact@v8
        with:
          name: vercel-ai-compatibility-results
          path: report/

      - name: üö® Create GitHub Issue
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            let reportBody = '';
            try {
              reportBody = fs.readFileSync('report/BREAKING_CHANGE_REPORT.md', 'utf8');
            } catch (e) {
              reportBody = `## Vercel AI SDK Breaking Change\n\nSee workflow run for details.`;
            }

            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility,vercel-ai',
              per_page: 5
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® [SDK Compatibility] Vercel AI SDK Breaking Changes (v${{ needs.compatibility.outputs.sdk_version }})',
                body: reportBody,
                labels: ['sdk-compatibility', 'vercel-ai', 'maintenance', 'breaking-change']
              });
            }
