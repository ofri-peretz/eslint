# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SDK Compatibility: jsonwebtoken (JWT ecosystem)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Proactively detect breaking changes in JWT-related packages that could affect
# eslint-plugin-jwt rules.
#
# MONITORED PACKAGES:
# - jsonwebtoken (primary)
# - jose (modern alternative)
# - express-jwt (middleware)
# - jwks-rsa (key management)
# - jwt-decode (client-side)
#
# SCHEDULE: Every Monday at 6 AM UTC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "SDK: JWT Ecosystem"

on:
  schedule:
    - cron: "0 6 * * 1"

  workflow_dispatch:
    inputs:
      package:
        description: "Specific package to test (leave empty for all)"
        required: false
        default: ""
      create_issue:
        description: "Create GitHub issue on failure"
        type: boolean
        default: true

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "10.18.3"
  PLUGIN_PATH: "packages/eslint-plugin-jwt"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COMPATIBILITY TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  compatibility:
    name: JWT Compatibility Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      test_passed: ${{ steps.test.outputs.passed }}
      versions: ${{ steps.versions.outputs.json }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERSION DISCOVERY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ” Get version information
        id: versions
        run: |
          # Get latest versions from npm
          JWT_LATEST=$(npm view jsonwebtoken version)
          JOSE_LATEST=$(npm view jose version)
          EXPRESS_JWT_LATEST=$(npm view express-jwt version)
          JWKS_RSA_LATEST=$(npm view jwks-rsa version)
          JWT_DECODE_LATEST=$(npm view jwt-decode version)

          echo "ğŸ“¦ Package versions:"
          echo "  jsonwebtoken: $JWT_LATEST"
          echo "  jose: $JOSE_LATEST"
          echo "  express-jwt: $EXPRESS_JWT_LATEST"
          echo "  jwks-rsa: $JWKS_RSA_LATEST"
          echo "  jwt-decode: $JWT_DECODE_LATEST"

          # Store as JSON for later use
          JSON=$(cat <<EOF
          {
            "jsonwebtoken": "$JWT_LATEST",
            "jose": "$JOSE_LATEST",
            "express-jwt": "$EXPRESS_JWT_LATEST",
            "jwks-rsa": "$JWKS_RSA_LATEST",
            "jwt-decode": "$JWT_DECODE_LATEST"
          }
          EOF
          )
          echo "json=$(echo $JSON | jq -c .)" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # INSTALL LATEST SDK VERSIONS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ”„ Install latest JWT packages
        run: |
          # Install at workspace root (proper monorepo pattern)
          pnpm add jsonwebtoken@latest jose@latest express-jwt@latest jwks-rsa@latest jwt-decode@latest --save-dev -w
          echo "âœ… Installed latest versions"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # RUN COMPATIBILITY TESTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ§ª Run Interface Compatibility Tests
        id: test
        continue-on-error: true
        run: |
          mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

          set +e
          pnpm vitest run \
            --reporter=verbose \
            --reporter=json \
            --outputFile=${{ env.PLUGIN_PATH }}/.compatibility-results/test-results.json \
            "${{ env.PLUGIN_PATH }}/src/__compatibility__/**/*.spec.ts" 2>&1 | tee ${{ env.PLUGIN_PATH }}/.compatibility-results/test-output.txt

          TEST_EXIT_CODE=$?
          set -e

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All compatibility tests passed!"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Compatibility tests failed!"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GENERATE REPORT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: ğŸ“ Generate Compatibility Report
        if: steps.test.outputs.passed == 'false'
        run: |
          mkdir -p ${{ env.PLUGIN_PATH }}/.compatibility-results

          cat << 'EOF' > ${{ env.PLUGIN_PATH }}/.compatibility-results/BREAKING_CHANGE_REPORT.md
          # ğŸš¨ JWT Ecosystem Breaking Change Report

          ## Summary

          The eslint-plugin-jwt interface compatibility tests have FAILED.
          This indicates potential breaking changes in one or more JWT packages.

          ## Packages Tested

          | Package | Version | Status |
          |---------|---------|--------|
          | jsonwebtoken | ${{ fromJSON(steps.versions.outputs.json).jsonwebtoken }} | See tests |
          | jose | ${{ fromJSON(steps.versions.outputs.json).jose }} | See tests |
          | express-jwt | ${{ fromJSON(steps.versions.outputs.json)['express-jwt'] }} | See tests |
          | jwks-rsa | ${{ fromJSON(steps.versions.outputs.json)['jwks-rsa'] }} | See tests |
          | jwt-decode | ${{ fromJSON(steps.versions.outputs.json)['jwt-decode'] }} | See tests |

          ## Affected Rules

          | Package | Rules That May Need Updates |
          |---------|---------------------------|
          | jsonwebtoken | no-algorithm-none, no-weak-secret, require-expiration, require-audience |
          | jose | require-algorithm-whitelist, no-insecure-key |
          | express-jwt | require-jwt-validation, no-exposed-secrets |
          | jwks-rsa | require-jwks-validation |
          | jwt-decode | no-client-side-decode-verify |

          EOF

      - name: ğŸ“¤ Upload Compatibility Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jwt-compatibility-results
          path: ${{ env.PLUGIN_PATH }}/.compatibility-results/
          retention-days: 30

      - name: ğŸ“Š Generate Workflow Summary
        if: always()
        run: |
          echo "## ğŸ”¬ JWT SDK Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| jsonwebtoken | ${{ fromJSON(steps.versions.outputs.json).jsonwebtoken }} |" >> $GITHUB_STEP_SUMMARY
          echo "| jose | ${{ fromJSON(steps.versions.outputs.json).jose }} |" >> $GITHUB_STEP_SUMMARY
          echo "| express-jwt | ${{ fromJSON(steps.versions.outputs.json)['express-jwt'] }} |" >> $GITHUB_STEP_SUMMARY
          echo "| jwks-rsa | ${{ fromJSON(steps.versions.outputs.json)['jwks-rsa'] }} |" >> $GITHUB_STEP_SUMMARY
          echo "| jwt-decode | ${{ fromJSON(steps.versions.outputs.json)['jwt-decode'] }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.passed }}" == "true" ]; then
            echo "**Status**: âœ… All compatible" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: âŒ Breaking changes detected" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ISSUE ON FAILURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-issue:
    name: Create Issue for Breaking Changes
    needs: compatibility
    runs-on: ubuntu-latest
    if: needs.compatibility.outputs.test_passed == 'false' && (github.event.inputs.create_issue != 'false' || github.event_name == 'schedule')

    steps:
      - name: ğŸ“¥ Download Compatibility Report
        uses: actions/download-artifact@v4
        with:
          name: jwt-compatibility-results
          path: report/

      - name: ğŸš¨ Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportBody = '';
            try {
              reportBody = fs.readFileSync('report/BREAKING_CHANGE_REPORT.md', 'utf8');
            } catch (e) {
              reportBody = `## JWT SDK Breaking Change Detected\n\nSee workflow run for details.`;
            }

            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility,jwt',
              per_page: 5
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ [SDK Compatibility] JWT Ecosystem Breaking Changes',
                body: reportBody,
                labels: ['sdk-compatibility', 'jwt', 'maintenance', 'breaking-change']
              });
            }
